---
title: 'Server Actions'
date: '2024-01-15'
description: 'Next 13 - Server Actions'
category: 'NextJS'
thumbnail: '/thumbnail/nextjs.png'
---

## ëª©ì°¨ 

# Server Actions?

Form ìƒíƒœ ê´€ë¦¬, ìºì‹±, ìœ íš¨ì„±ê²€ì‚¬ ê´€ë ¨í•˜ì—¬ nextì—ì„œ ìƒˆë¡­ê²Œ ì œì‹œí•˜ëŠ” solutionì´ë‹¤.

Form ë°ì´í„°ë¡œ ì„œë²„ì˜ ë°ì´í„°ë¥¼ ë³€ê²½í•˜ê³ , ì¤‘ê°„ API ë ˆì´ì–´ ì—†ì´ ì„œë²„ì—ì„œ ë™ì‘í•˜ëŠ” í•¨ìˆ˜ë¥¼ í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì§ì ‘ ì‹¤í–‰ì‹œí‚¬ ìˆ˜ ìˆë‹¤.

- ì»´í¬ë„ŒíŠ¸ì—ì„œ ìì²´ì—ì„œ ë¹„ë™ê¸° ì„œë²„í•¨ìˆ˜ë¥¼ ì •ì˜í•¨
- ì„œë²„ ì»´í¬ë„ŒíŠ¸ì—ì„œ ì •ì˜, í•¨ìˆ˜í˜• ì»´í¬ë„ŒíŠ¸ì—ì„œ í˜¸ì¶œ
- API ì—”ë“œí¬ì¸íŠ¸ë¥¼ ì„ì˜ë¡œ ìƒì„±í•  í•„ìš”ê°€ ì—†ë‹¤
- JSì—†ì´ formì´ ì‘ë™í•  ìˆ˜ ìˆê²Œ í•œë‹¤. (disableí•´ë„ ë¨)

### ì ì§„ì  í–¥ìƒ (Progressive Enhancement)

> Progressive EnhancementëŠ” JSê°€ ë¹„í™œì„±í™”ë˜ì—ˆê±°ë‚˜ JSë¡œë“œì— ì‹¤íŒ¨í•œ ê²½ìš°ì—ë„ formì´ ì œëŒ€ë¡œ ì‘ë™í•˜ë„ë¡ í•˜ëŠ” ê¸°ëŠ¥ì´ë‹¤. ì´ë¥¼ í†µí•´ JSë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šì•„ë„ ì‚¬ìš©ìê°€ ì–‘ì‹ê³¼ ìƒí˜¸ì‘ìš©í•˜ê³  ë°ì´í„°ë¥¼ ì œì¶œí•  ìˆ˜ ìˆë‹¤.
> 

# ğŸ›ï¸Â ì–´ë–»ê²Œ í˜¸ì¶œ?

í•¨ìˆ˜ ë³¸ë¬¸ ìƒë‹¨ì— â€œuse serverâ€ ì§€ì‹œë¬¸ì„ ì‚¬ìš©í•˜ì—¬ ë³„ë„ì˜ íŒŒì¼ì— ì„œë²„ ì‘ì—…ì„ ë§Œë“ ë‹¤. ê·¸ëŸ° ë‹¤ìŒ ì„œë²„ ì‘ì—…ì„ í´ë¼ì´ì–¸íŠ¸ êµ¬ì„± ìš”ì†Œë¡œ ê°€ì ¸ì˜¨ë‹¤.

```ts:/app/lib/action.ts 
// (ì„œë²„ ì‘ì—…)
'use server';
export async function myAction() {
 //...logic
}
```

```ts:/app/components/ClientComponent.tsx 
// (í´ë¼ì´ì–¸íŠ¸ì—ì„œ ê°€ì ¸ì˜¤ê¸°)
'use client';
import { myAction} from "@/lib/actions";

export default function ClientComponent() {
    return // ...
}

```

## âš™ï¸ JSON Server ì‚¬ìš©í•˜ê¸° (testìš©)

```bash
sudo npm install -g json-server
```

ë£¨íŠ¸ì— db.json ìƒì„± (ì˜ˆì‹œ)

```json:/db.json
{
  "todos": [
    {
      "userId": 1,
      "title": "ë°¥ë¨¹ê¸°",
      "completed": false,
      "id": 3
    },
    {
      "userId": 1,
      "title": "ìš´ë™í•˜ê¸°2",
      "completed": false,
      "id": 5
    }
  ]
}
```

ì›í•˜ëŠ” í¬íŠ¸ë²ˆí˜¸ë¡œ ì„œë²„ì‹¤í–‰

```bash
json-server --watch db.json -p 3001
```

# ğŸ§‘ğŸ»â€ğŸ’»Â ì‚¬ìš©

## 1. formíƒœê·¸ì˜ `action` prop

```ts
// /app/lib/actions.ts
'use server';
import { revalidatePath } from 'next/cache';
...

export type Todo = {
  userId: number;
  id: number;
  title: string;
  completed: boolean;
};

export async function addTodo(data: FormData) {
  const title = data.get('title');
  await fetch('http://localhost:3001/todos', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      userId: 1,
      title,
      completed: false,
    }),
  });
  // ìºì‹œë˜ì–´ìˆë˜ ë°ì´í„°ë¥¼ ì œê±° (í•˜ë‚˜ê°€ ì¶”ê°€ë˜ì—ˆìœ¼ë¯€ë¡œ)
  revalidatePath('/');
}
```

```tsx
// client
import { addTodo } from '@/lib/actions';

export default function Form() {
  return (
    <form action={addTodo}>
      <input
        type='text'
        name='title'
				...
      />
      <button type='submit'>submit</button>
    </form>
  );
}
```

### revalidatePath

`revalidatePath('/URL')` 

- í•´ë‹¹ /URLì— ìˆë˜ ìºì‹œë¥¼ ì‚­ì œí•˜ê³  ë‹¤ì‹œ ìƒì„±í•´ì£¼ëŠ” í•¨ìˆ˜ì´ë‹¤.
- í˜ì´ì§€ë¥¼ ë‹¤ì‹œ ë¡œë“œí•´ì£¼ëŠ” ê¸°ëŠ¥ë„ ìˆë‹¤.
- ê·¸ëƒ¥ ìƒˆë¡œê³ ì¹¨ì´ ì•„ë‹Œ ì°¨ì´ì ë§Œ ë°”ê¿”ì£¼ëŠ” ì´ìœ ìƒˆë¡œê³ ì¹¨ì´ë‹¤.

## 2. `formAction` prop

form ì•ˆì— ìˆëŠ” ë²„íŠ¼ìš”ì†Œ ë“±ì— ì‚¬ìš©

```tsx
// app/lib/actions.ts
...

export async function deleteTodo(todo: Todo) {
  const res = await fetch(`http://localhost:3001/todos/${todo.id}`, {
    method: 'DELETE',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      id: todo.id,
    }),
  });
  await res.json();
  revalidatePath('/');
}
```

```tsx
// client
import { Todo, deleteTodo } from '@/lib/actions';
...
export default function TodoItem(todo: Todo) {
  return (
    <form>
      ...
        <button
          formAction={async () => {
            'use server';
            await deleteTodo(todo);
          }}
        >
          ì‚­ì œ
        </button>
    </form>
  );
}
```

## 3. client componentì—ì„œ ì‚¬ìš© â†’ `startTransition`

ì´ ë°©ë²•ì€ **Progressive Enhancement**ë¥¼ **ë¹„í™œì„±í™”**í•œë‹¤.

```tsx
// app/lib/actions.ts
...
export async function updateTodo(todo: Todo) {
  const res = await fetch(`http://localhost:3001/todos/${todo.id}`, {
    method: 'PUT',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      ...todo, completed: !todo.completed,
    }),
  });
  await res.json();
  revalidatePath('/');
}
```

```tsx
// client
'use client';
import { Todo, updateTodo } from '@/lib/actions';
import React, { useTransition } from 'react';

export default function Checkbox({ todo }: { todo: Todo }) {

  // ë°ì´í„°ê°€ ë°”ë€ŒëŠ” ë„ì¤‘ì—ëŠ” isPendingì´ true
   const [isPending, startTransition] = useTransition();

   return (
     <input
       type='checkbox'
       checked={todo.completed}
       id='completed'
       name='completed'
       disabled={isPending}
       onChange={() => {
         startTransition(() => updateTodo(todo));
       }}
     />
   );
}
```

### useTransition

React 18ì—ì„œ ë„ì…ëœ ìƒˆë¡œìš´ í›…

> useTransitionì€ UIë¥¼ ì°¨ë‹¨í•˜ì§€ ì•Šê³  ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸í•  ìˆ˜ ìˆëŠ” React Hookì´ë‹¤.
> 
- isPending: pendingì¤‘ì—ëŠ” true, ì•„ë‹ˆë©´ false
- startTransition: ìƒíƒœ ì—…ë°ì´íŠ¸ë¥¼ transitionìœ¼ë¡œ í‘œì‹œí•  ìˆ˜ ìˆê²Œ í•´ì¤Œ. ì—¬ê¸°ë‹¤ê°€ í•¨ìˆ˜ë¥¼ ë„£ì–´ì£¼ë©´ ê·¸ í•¨ìˆ˜ê°€ ì‹¤í–‰ë˜ëŠ” ë™ì•ˆì€ pending ìƒíƒœì¸ê²ƒ.

### useOptimistic í™œìš©

server actionì´ ëë‚˜ê¸°ì „ì— ë¯¸ë¦¬ UIë¥¼ ì—…ë°ì´íŠ¸í•´ì¤€ë‹¤.

â†’ ë°±ì—”ë“œì˜ ì‘ì—…ì´ ëë‚˜ê¸°ì „ì— ë°”ë€ë‹¤ëŠ” ëœ» (ì‚¬ìš©ì ê²½í—˜ í–¥ìƒ)

â†’ server actionì´ í˜¸ì¶œë˜ë©´ ì‘ë‹µì„ ê¸°ë‹¤ë¦¬ì§€ ì•Šê³  ì˜ˆìƒ ê²°ê³¼ë¥¼ ë°˜ì˜í•˜ì—¬ UIê°€ ì—…ë°ì´íŠ¸ë˜ëŠ” ë°©ì‹

```tsx
'use client';
import { Todo, updateTodo } from '@/lib/actions';
import React, { useOptimistic } from 'react';

export default function Checkbox({ todo }: { todo: Todo }) {
  const [optimisticTodo, addOptimisticTodo] = useOptimistic(
    todo,
    (state: Todo, completed: boolean) => ({ ...state, completed })
  );

return (
    <input
      type='checkbox'
      checked={todo.completed}
      id='completed'
      name='completed' 
      onChange={async () => {
        addOptimisticTodo(!todo.completed);
        await updateTodo(todo)
      }}
    />
  );
}
```